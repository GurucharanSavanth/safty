<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - Citizen Safety Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0a0f1e 0%, #1a1f35 100%); color: #f1f5f9; min-height: 100vh; padding: 20px; }
    .dashboard-container { max-width: 1600px; margin: 0 auto; }
    .header { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(20px); border: 2px solid rgba(51, 65, 85, 0.5); border-radius: 20px; padding: 32px; margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
    .header-title h1 { font-size: 2rem; font-weight: 800; margin-bottom: 8px; }
    .header-subtitle { color: #94a3b8; font-size: 0.875rem; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #8b5cf6); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; }
    .user-details { display: flex; flex-direction: column; }
    .user-name { font-weight: 700; font-size: 1.1rem; }
    .user-role { font-size: 0.875rem; color: #94a3b8; text-transform: capitalize; }
    .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .action-btn { padding: 12px 24px; border: none; border-radius: 12px; font-weight: 700; font-size: 0.875rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; text-decoration: none; white-space: nowrap; }
    .action-btn.primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
    .action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }
    .action-btn.secondary { background: rgba(51, 65, 85, 0.5); border: 2px solid #475569; color: #f1f5f9; }
    .action-btn.secondary:hover { background: rgba(71, 85, 105, 0.5); transform: translateY(-2px); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: rgba(30, 41, 59, 0.8); border: 2px solid rgba(51, 65, 85, 0.5); border-radius: 16px; padding: 24px; transition: all 0.3s; }
    .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3); }
    .stat-value { font-size: 2.5rem; font-weight: 800; margin-bottom: 8px; }
    .stat-label { color: #94a3b8; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .section-card { background: rgba(30, 41, 59, 0.8); border: 2px solid rgba(51, 65, 85, 0.5); border-radius: 20px; padding: 32px; margin-bottom: 32px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .section-title { font-size: 1.5rem; font-weight: 700; }
    .report-grid { display: grid; gap: 12px; }
    .report-card { padding: 20px; background: rgba(51, 65, 85, 0.3); border: 2px solid rgba(71, 85, 105, 0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s; }
    .report-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); border-color: #3b82f6; }
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .status-pending { background: #f59e0b; color: white; }
    .status-in-progress { background: #3b82f6; color: white; }
    .status-resolved { background: #22c55e; color: white; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #1e293b; border: 2px solid #334155; border-radius: 20px; padding: 32px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-title { font-size: 1.5rem; font-weight: 700; }
    .close-btn { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; }
    .close-btn:hover { color: #f1f5f9; transform: rotate(90deg); }
    @media (max-width: 768px) {
      .header { padding: 20px; }
      .header-title h1 { font-size: 1.5rem; }
      .action-btn { padding: 10px 16px; font-size: 0.75rem; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .stat-value { font-size: 1.75rem; }
      .section-card { padding: 20px; }
      .modal-content { padding: 20px; }
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <h1>üë§ User Dashboard</h1>
        <p class="header-subtitle">Welcome back!</p>
      </div>

      <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="user-name" id="userName">User</div>
            <div class="user-role" id="userRole">viewer</div>
          </div>
        </div>

        <div class="header-actions">
          <a href="index.html" class="action-btn primary">‚ûï New Report</a>
          <a href="heatmap-page.html" class="action-btn secondary">üó∫Ô∏è Map</a>
          <button class="action-btn secondary" onclick="handleLogout()">üö™ Logout</button>
        </div>
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="myReports" style="color: #3b82f6;">0</div>
        <div class="stat-label">My Reports</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="pendingReports" style="color: #f59e0b;">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="inProgressReports" style="color: #3b82f6;">0</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="resolvedReports" style="color: #22c55e;">0</div>
        <div class="stat-label">Resolved</div>
      </div>
    </div>

    <!-- My Reports -->
    <div class="section-card">
      <div class="section-header">
        <h2 class="section-title">üìã My Reports</h2>
        <button class="action-btn secondary" onclick="refreshReports()">üîÑ Refresh</button>
      </div>
      <div id="reportsList" class="report-grid">Loading...</div>
    </div>

    <!-- Recent Activity -->
    <div class="section-card">
      <div class="section-header">
        <h2 class="section-title">‚è±Ô∏è Recent Activity</h2>
      </div>
      <div id="recentActivity">Loading...</div>
    </div>
  </div>

  <!-- MODAL: Report Details -->
  <div id="reportDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üìã Report Details</h2>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>

      <div id="reportDetailContent">
        <div style="background: rgba(51, 65, 85, 0.3); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <strong style="color: #cbd5e1;">Report ID:</strong>
              <div id="detailReportId" style="font-size: 1.1rem; margin-top: 4px;">-</div>
            </div>
            <div>
              <strong style="color: #cbd5e1;">Type:</strong>
              <div id="detailReportType" style="font-size: 1.1rem; margin-top: 4px;">-</div>
            </div>
          </div>
        </div>

        <div style="background: rgba(51, 65, 85, 0.3); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <strong style="color: #cbd5e1;">Status:</strong>
          <div style="margin-top: 12px;">
            <span id="currentStatus" class="status-badge">-</span>
          </div>
        </div>

        <div id="locationSection" style="background: rgba(51, 65, 85, 0.3); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <strong style="color: #cbd5e1;">üìç Location:</strong>
          <div id="detailLocation" style="margin-top: 8px; color: #94a3b8;">-</div>
          <div id="geotagSection" style="margin-top: 12px; display: none;">
            <a id="googleMapsLink" href="#" target="_blank" class="action-btn primary" style="padding: 8px 16px; display: inline-flex;">
              üó∫Ô∏è Open in Google Maps
            </a>
          </div>
        </div>

        <div style="background: rgba(51, 65, 85, 0.3); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <strong style="color: #cbd5e1;">Description:</strong>
          <div id="detailDescription" style="margin-top: 8px; color: #f1f5f9; line-height: 1.6;">-</div>
        </div>

        <div id="imagesSection" style="background: rgba(51, 65, 85, 0.3); padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none;">
          <strong style="color: #cbd5e1;">üì∏ Images:</strong>
          <div id="detailImages" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 12px;"></div>
        </div>

        <div id="audioSection" style="background: rgba(51, 65, 85, 0.3); padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none;">
          <strong style="color: #cbd5e1;">üé§ Audio Recording:</strong>
          <audio id="detailAudio" controls style="width: 100%; margin-top: 12px;"></audio>
        </div>

        <div style="background: rgba(51, 65, 85, 0.3); padding: 16px; border-radius: 8px;">
          <strong style="color: #cbd5e1;">Metadata:</strong>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; font-size: 0.875rem;">
            <div>
              <strong>Created:</strong>
              <div id="detailCreatedAt" style="color: #94a3b8;">-</div>
            </div>
            <div id="detailUpdatedAtSection" style="display: none;">
              <strong>Updated:</strong>
              <div id="detailUpdatedAt" style="color: #94a3b8;">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/utils.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/profile-manager.js"></script>

  <script>
    let currentUser = null;
    let currentReportDetail = null;

    document.addEventListener('DOMContentLoaded', () => {
      if (!ProfileManager.isAuthenticated()) {
        window.location.href = 'profile-login.html';
        return;
      }

      currentUser = ProfileManager.getCurrentUser();
      displayUserInfo();
      loadDashboard();
    });

    function displayUserInfo() {
      const initial = currentUser.fullName ? currentUser.fullName.charAt(0).toUpperCase() : currentUser.username.charAt(0).toUpperCase();
      document.getElementById('userAvatar').textContent = initial;
      document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
      document.getElementById('userRole').textContent = currentUser.role;
    }

    function loadDashboard() {
      loadStatistics();
      loadReports();
      loadRecentActivity();
    }

    function loadStatistics() {
      try {
        const myReports = ProfileManager.getFilteredReports(currentUser);
        const pending = myReports.filter(r => (r.status || 'pending') === 'pending').length;
        const inProgress = myReports.filter(r => r.status === 'in-progress').length;
        const resolved = myReports.filter(r => r.status === 'resolved').length;

        document.getElementById('myReports').textContent = myReports.length;
        document.getElementById('pendingReports').textContent = pending;
        document.getElementById('inProgressReports').textContent = inProgress;
        document.getElementById('resolvedReports').textContent = resolved;
      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // ‚úÖ PATCHED: loadReports() now displays image thumbnails
    function loadReports() {
      try {
        const reports = ProfileManager.getFilteredReports(currentUser);
        const container = document.getElementById('reportsList');

        if (reports.length === 0) {
          container.innerHTML = '<p style="color: #94a3b8; padding: 32px; text-align: center;">No reports found. Create your first report!</p>';
          return;
        }

        container.innerHTML = reports.map(report => {
          // ‚úÖ IMAGE FIX: Handle both photo (single) and images (array)
          let imageList = [];
          if (report.images && Array.isArray(report.images) && report.images.length > 0) {
            imageList = report.images;
          } else if (report.photo) {
            imageList = [report.photo];
          }
          const hasImages = imageList.length > 0;
          const firstImage = hasImages ? imageList[0] : null;
          const imageCount = imageList.length;

          return `
            <div class="report-card" onclick="openReportDetail('${report.id}', '${report.type}')">
              <div style="display: flex; gap: 16px; align-items: start;">
                ${firstImage ? `
                  <div style="flex-shrink: 0; position: relative;">
                    <img src="${firstImage}" alt="Report" 
                         style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #475569;">
                    ${imageCount > 1 ? `
                      <span style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700;">
                        +${imageCount - 1} üì∏
                      </span>
                    ` : ''}
                  </div>
                ` : ''}

                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="font-size: 1.5rem;">${report.type === 'police' ? 'üöî' : report.type === 'medical' ? 'üöë' : 'üèóÔ∏è'}</span>
                    <div>
                      <div style="font-weight: 700; font-size: 1.1rem;">${report.id}</div>
                      <div style="color: #94a3b8; font-size: 0.875rem;">${report.type.toUpperCase()}</div>
                    </div>
                  </div>
                  <div style="color: #cbd5e1; margin-top: 8px; line-height: 1.5;">
                    ${(report.description || report.details || 'No description').substring(0, 150)}${(report.description || report.details || '').length > 150 ? '...' : ''}
                  </div>
                  ${report.location && report.location.latitude ? `
                    <div style="color: #94a3b8; font-size: 0.875rem; margin-top: 8px;">
                      üìç ${report.location.latitude.toFixed(4)}, ${report.location.longitude.toFixed(4)}
                    </div>
                  ` : ''}
                </div>

                <div style="text-align: right; flex-shrink: 0;">
                  <span class="status-badge status-${report.status || 'pending'}">${report.status || 'pending'}</span>
                  <div style="color: #94a3b8; font-size: 0.75rem; margin-top: 8px;">
                    ${new Date(report.createdAt).toLocaleDateString()}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading reports:', error);
      }
    }

    function openReportDetail(reportId, reportType) {
      const report = Storage.getReportById(reportType, reportId);
      if (!report) {
        alert('Report not found');
        return;
      }

      currentReportDetail = { id: reportId, type: reportType, data: report };

      document.getElementById('detailReportId').textContent = report.id;
      document.getElementById('detailReportType').textContent = reportType.toUpperCase();
      document.getElementById('detailDescription').textContent = report.description || report.details || 'No description provided';
      document.getElementById('detailCreatedAt').textContent = new Date(report.createdAt).toLocaleString();

      const statusSpan = document.getElementById('currentStatus');
      statusSpan.textContent = report.status || 'pending';
      statusSpan.className = `status-badge status-${report.status || 'pending'}`;

      if (report.location || report.geolocation) {
        const loc = report.location || report.geolocation;
        if (typeof loc === 'object' && loc.latitude && loc.longitude) {
          document.getElementById('detailLocation').innerHTML = `
            <strong>Coordinates:</strong><br>
            Latitude: ${loc.latitude.toFixed(6)}<br>
            Longitude: ${loc.longitude.toFixed(6)}
            ${loc.address ? `<br><br><strong>Address:</strong><br>${loc.address}` : ''}
          `;
          document.getElementById('geotagSection').style.display = 'block';
          document.getElementById('googleMapsLink').href = `https://www.google.com/maps?q=${loc.latitude},${loc.longitude}`;
        } else {
          document.getElementById('detailLocation').textContent = loc.toString();
          document.getElementById('geotagSection').style.display = 'none';
        }
        document.getElementById('locationSection').style.display = 'block';
      } else {
        document.getElementById('locationSection').style.display = 'none';
      }

      // ‚úÖ IMAGE FIX: Handle both photo (single) and images (array)
      let imageList = [];
      if (report.images && Array.isArray(report.images) && report.images.length > 0) {
        imageList = report.images;
      } else if (report.photo) {
        imageList = [report.photo];
      }

      if (imageList.length > 0) {
        document.getElementById('imagesSection').style.display = 'block';
        document.getElementById('detailImages').innerHTML = imageList.map(img => `
          <div style="position: relative; border-radius: 8px; overflow: hidden; border: 2px solid #475569;">
            <img src="${img}" alt="Report image" style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;" onclick="window.open('${img}', '_blank')">
          </div>
        `).join('');
      } else {
        document.getElementById('imagesSection').style.display = 'none';
      }

      if (report.audioUrl || report.audioData) {
        document.getElementById('audioSection').style.display = 'block';
        document.getElementById('detailAudio').src = report.audioUrl || report.audioData;
      } else {
        document.getElementById('audioSection').style.display = 'none';
      }

      if (report.updatedAt) {
        document.getElementById('detailUpdatedAtSection').style.display = 'block';
        document.getElementById('detailUpdatedAt').textContent = new Date(report.updatedAt).toLocaleString();
      } else {
        document.getElementById('detailUpdatedAtSection').style.display = 'none';
      }

      document.getElementById('reportDetailModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('reportDetailModal').classList.remove('active');
    }

    function refreshReports() {
      loadDashboard();
      alert('Reports refreshed!');
    }

    function loadRecentActivity() {
      const container = document.getElementById('recentActivity');
      const reports = ProfileManager.getFilteredReports(currentUser);

      if (reports.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; padding: 20px; text-align: center;">No activity yet</p>';
        return;
      }

      const recent = reports.slice(0, 5);
      container.innerHTML = recent.map(r => `
        <div style="padding: 12px; background: rgba(51, 65, 85, 0.3); border-radius: 8px; margin-bottom: 8px;">
          <div style="display: flex; justify-content: space-between;">
            <div><span style="font-weight: 600;">${r.id}</span> - ${r.type.toUpperCase()}</div>
            <div style="font-size: 0.75rem; color: #94a3b8;">${new Date(r.createdAt).toLocaleString()}</div>
          </div>
        </div>
      `).join('');
    }

    function handleLogout() {
      ProfileManager.logout();
      window.location.href = 'profile-login.html';
    }

    document.getElementById('reportDetailModal').addEventListener('click', (e) => {
      if (e.target.id === 'reportDetailModal') {
        closeModal();
      }
    });

    console.log('‚úÖ User Dashboard loaded successfully - WITH IMAGE THUMBNAILS');
  </script>

</body>
</html>

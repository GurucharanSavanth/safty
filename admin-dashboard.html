<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Citizen Safety Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0f1e 0%, #1a1f35 100%);
      color: #f1f5f9;
      min-height: 100vh;
      padding: 20px;
    }

    .dashboard-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(51, 65, 85, 0.5);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: rgba(30, 41, 59, 0.8);
      border: 2px solid rgba(51, 65, 85, 0.5);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .stat-label {
      color: #94a3b8;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .reports-section {
      background: rgba(30, 41, 59, 0.8);
      border: 2px solid rgba(51, 65, 85, 0.5);
      border-radius: 20px;
      padding: 32px;
    }

    .report-card {
      background: rgba(30, 41, 59, 0.8);
      border: 2px solid rgba(51, 65, 85, 0.5);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .report-card:hover {
      border-color: #3b82f6;
      transform: translateX(4px);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 9999;
      padding: 20px;
      overflow-y: auto;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 20px;
      padding: 32px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <!-- Header -->
    <div class="header">
      <div>
        <h1 style="font-size: 1.75rem; font-weight: 800; margin-bottom: 4px;">üëë Admin Dashboard</h1>
        <p style="color: #94a3b8;">Manage all reports and system settings</p>
      </div>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button onclick="refreshDashboard()" class="btn btn-primary">üîÑ Refresh</button>
        <button onclick="window.location.href='index.html'" class="btn btn-success">üè† Home</button>
        <button onclick="handleLogout()" class="btn btn-danger">üö™ Logout</button>
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid" id="statsGrid">
      <!-- Stats populated by JavaScript -->
    </div>

    <!-- Reports Section -->
    <div class="reports-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
        <h2 style="font-size: 1.5rem; font-weight: 700;">üìä All Reports</h2>
        <input type="text" id="searchBox" placeholder="üîç Search reports..." style="padding: 10px 16px; background: rgba(30, 41, 59, 0.8); border: 2px solid rgba(51, 65, 85, 0.5); border-radius: 8px; color: #f1f5f9; width: 300px;" oninput="filterReports()">
      </div>

      <div id="reportsList">
        <div class="empty-state">
          <div style="font-size: 4rem; margin-bottom: 16px;">üìä</div>
          <h3 style="font-size: 1.25rem; margin-bottom: 8px;">Loading Reports...</h3>
          <p>Please wait</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div id="modalBody"></div>
      <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
        <button onclick="closeModal()" class="btn btn-danger">Close</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/utils.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/profile-manager.js"></script>

  <script>
    let allReports = [];

    // Initialize dashboard
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Admin Dashboard Loading...');
      loadDashboard();
      
      // Auto-refresh every 5 seconds
      setInterval(refreshDashboard, 5000);
    });

    function loadDashboard() {
      try {
        console.log('üìä Loading dashboard data...');

        // Check if Storage is available
        if (typeof Storage === 'undefined') {
          console.error('‚ùå Storage module not loaded');
          alert('Storage module not loaded. Please refresh the page.');
          return;
        }

        // Get all reports
        allReports = Storage.getAllReportsOfAllTypes();
        console.log('‚úì Loaded', allReports.length, 'reports');

        // Update UI
        updateStatistics();
        displayReports(allReports);

      } catch (error) {
        console.error('‚ùå Dashboard load error:', error);
        alert('Failed to load dashboard: ' + error.message);
      }
    }

    function updateStatistics() {
      try {
        const stats = Storage.getStatistics();
        console.log('üìà Statistics:', stats);

        const statsGrid = document.getElementById('statsGrid');
        if (!statsGrid) return;

        statsGrid.innerHTML = `
          <div class="stat-card" style="border-color: #3b82f6;">
            <div class="stat-value" style="color: #3b82f6;">${stats.police || 0}</div>
            <div class="stat-label">Police Reports</div>
          </div>
          <div class="stat-card" style="border-color: #ef4444;">
            <div class="stat-value" style="color: #ef4444;">${stats.medical || 0}</div>
            <div class="stat-label">Medical Reports</div>
          </div>
          <div class="stat-card" style="border-color: #f59e0b;">
            <div class="stat-value" style="color: #f59e0b;">${stats.infrastructure || 0}</div>
            <div class="stat-label">Infrastructure</div>
          </div>
          <div class="stat-card" style="border-color: #8b5cf6;">
            <div class="stat-value" style="color: #8b5cf6;">${stats.total || 0}</div>
            <div class="stat-label">Total Reports</div>
          </div>
          <div class="stat-card" style="border-color: #f59e0b;">
            <div class="stat-value" style="color: #f59e0b;">${stats.pending || 0}</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card" style="border-color: #3b82f6;">
            <div class="stat-value" style="color: #3b82f6;">${stats.inProgress || 0}</div>
            <div class="stat-label">In Progress</div>
          </div>
          <div class="stat-card" style="border-color: #22c55e;">
            <div class="stat-value" style="color: #22c55e;">${stats.resolved || 0}</div>
            <div class="stat-label">Resolved</div>
          </div>
        `;
      } catch (error) {
        console.error('‚ùå Update statistics error:', error);
      }
    }

    function displayReports(reports) {
      const reportsList = document.getElementById('reportsList');
      if (!reportsList) return;

      console.log('üìã Displaying', reports.length, 'reports');

      if (reports.length === 0) {
        reportsList.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 4rem; margin-bottom: 16px;">üì≠</div>
            <h3 style="font-size: 1.25rem; margin-bottom: 8px;">No Reports Yet</h3>
            <p>Reports will appear here once submitted</p>
            <button onclick="refreshDashboard()" class="btn btn-primary" style="margin-top: 16px;">üîÑ Refresh Now</button>
          </div>
        `;
        return;
      }

      const colors = { police: '#3b82f6', medical: '#ef4444', infrastructure: '#f59e0b' };
      const icons = { police: 'üöî', medical: 'üöë', infrastructure: 'üèóÔ∏è' };

      reportsList.innerHTML = reports.map(report => {
        const color = colors[report.type] || '#64748b';
        const icon = icons[report.type] || 'üìã';
        const statusColor = 
          report.status === 'resolved' ? '#22c55e' :
          report.status === 'in-progress' ? '#f59e0b' : '#ef4444';
        
        return `
          <div class="report-card" onclick="viewReport('${report.type}', '${report.id}')">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <div style="display: flex; gap: 12px; align-items: center;">
                <span style="font-size: 1.5rem;">${icon}</span>
                <div>
                  <div style="font-weight: 700; color: ${color};">${report.id}</div>
                  <div style="color: #94a3b8; font-size: 0.875rem; text-transform: capitalize;">${report.type}</div>
                </div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span style="padding: 4px 12px; background: rgba(${
                  report.status === 'resolved' ? '34,197,94' :
                  report.status === 'in-progress' ? '245,158,11' : '239,68,68'
                }, 0.2); border: 1px solid ${statusColor}; border-radius: 20px; color: ${statusColor}; font-size: 0.75rem; font-weight: 600;">${report.status || 'pending'}</span>
                <button onclick="event.stopPropagation(); deleteReport('${report.type}', '${report.id}')" style="padding: 6px 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 8px; color: #ef4444; cursor: pointer; font-weight: 600;">üóëÔ∏è Delete</button>
              </div>
            </div>
            <div style="color: #94a3b8; font-size: 0.875rem;">
              <div><strong>Created:</strong> ${report.timestamp?.full || new Date(report.createdAt).toLocaleString()}</div>
              ${report.location?.isReal ? `<div><strong>Location:</strong> ${report.location.latitude.toFixed(4)}, ${report.location.longitude.toFixed(4)}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function viewReport(type, id) {
      const report = Storage.getReportById(type, id);
      if (!report) {
        alert('Report not found');
        return;
      }

      const colors = { police: '#3b82f6', medical: '#ef4444', infrastructure: '#f59e0b' };
      const color = colors[type] || '#64748b';

      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <h2 style="margin-bottom: 24px;">Report: ${id}</h2>
        
        ${report.photo ? `<img src="${report.photo}" style="width: 100%; border-radius: 12px; margin-bottom: 24px;">` : ''}
        
        <div style="background: rgba(${color === '#3b82f6' ? '59,130,246' : color === '#ef4444' ? '239,68,68' : '245,158,11'}, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <div style="display: grid; gap: 12px;">
            <div><strong>Type:</strong> ${type}</div>
            <div><strong>Status:</strong> ${report.status || 'pending'}</div>
            <div><strong>Created:</strong> ${report.timestamp?.full || new Date(report.createdAt).toLocaleString()}</div>
            ${report.location?.isReal ? `<div><strong>Location:</strong> ${report.location.latitude.toFixed(6)}, ${report.location.longitude.toFixed(6)}</div>` : ''}
          </div>
        </div>

        <div style="margin-top: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Update Status:</label>
          <select id="statusSelect" style="width: 100%; padding: 12px; background: rgba(30, 41, 59, 0.8); border: 2px solid rgba(51, 65, 85, 0.5); border-radius: 8px; color: #f1f5f9; margin-bottom: 12px;">
            <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="in-progress" ${report.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
            <option value="resolved" ${report.status === 'resolved' ? 'selected' : ''}>Resolved</option>
          </select>
          <button onclick="updateStatus('${type}', '${id}')" class="btn btn-success" style="width: 100%;">‚úì Update Status</button>
        </div>
      `;

      document.getElementById('reportModal').classList.add('show');
    }

    function updateStatus(type, id) {
      const newStatus = document.getElementById('statusSelect').value;
      const success = Storage.updateReportStatus(type, id, newStatus);
      
      if (success) {
        alert('‚úÖ Status updated successfully!');
        closeModal();
        refreshDashboard();
      } else {
        alert('‚ùå Failed to update status');
      }
    }

    function deleteReport(type, id) {
      if (!confirm('Delete this report? This cannot be undone!')) {
        return;
      }

      const success = Storage.deleteReport(type, id);
      
      if (success) {
        alert('‚úÖ Report deleted successfully!');
        refreshDashboard();
      } else {
        alert('‚ùå Failed to delete report');
      }
    }

    function filterReports() {
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();
      const filtered = allReports.filter(r => 
        r.id.toLowerCase().includes(searchTerm) ||
        r.type.toLowerCase().includes(searchTerm) ||
        (r.status && r.status.toLowerCase().includes(searchTerm))
      );
      displayReports(filtered);
    }

    function closeModal() {
      document.getElementById('reportModal').classList.remove('show');
    }

    function refreshDashboard() {
      console.log('üîÑ Refreshing dashboard...');
      loadDashboard();
    }

    function handleLogout() {
      if (confirm('Logout?')) {
        window.location.href = 'index.html';
      }
    }

    // Debug function
    window.debugStorage = function() {
      Storage.debugShowAll();
    };
  </script>

</body>
</html>
